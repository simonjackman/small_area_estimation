mutate(
Division = str_to_title(Division),
Division = gsub(Division,
pattern = "Mc([a-z])",
replacement = "Mc\\U\\1",
perl = TRUE),
Division = if_else(Division == "O'connor",
"O'Connor",
Division)
)
tpp <- read_csv(
file = url(
"https://results.aec.gov.au/27966/Website/Downloads/HouseTppByDivisionDownload-27966.csv"
),
skip = 1
) %>%
select(DivisionNm,
alp_tpp_per = `Australian Labor Party Percentage`)
ced_labels <- readxl::read_xlsx(
here(
"common_data/Census/2021/CED/2021_GCP_CED_for_AUS_short-header/Metadata/2021Census_geog_desc_1st_and_2nd_release.xlsx"
),
sheet = "2021_ASGS_Non_ABS_Structures") %>%
rename(CED_CODE_2021 = Census_Code_2021, div_nm = Census_Name_2021) %>%
filter(grepl("^CED", CED_CODE_2021))
aec_data <- purrr::reduce(
list(
fp_per,
tpp,
turnout %>%
select(DivisionNm,Turnout),
enrolment %>%
rename(DivisionNm = Division),
ced_labels %>%
filter(div_nm != "Australia") %>%
select(CED_CODE_2021, DivisionNm = div_nm, area = `Area sqkm`)
),
left_join,
by = "DivisionNm") %>%
mutate(TurnoutPercentage = Turnout/enrolment*100) %>%
select(-state) %>%
rename(state=StateAb,Division=DivisionNm)
enrolment_current <- read_csv(
file =
here(
"common_data/elections/aec/elector_counts/DivisionalEnrolment/2023_05.csv"
),
skip = 1
) %>%
mutate(Division = str_to_title(Division),
Enrolment_Current = as.numeric(Enrolment)) %>%
mutate(
Division = gsub(
Division,
pattern = "Mc([a-z])",
replacement = "Mc\\U\\1",
perl = TRUE
),
Division = if_else(Division == "O'connor",
"O'Connor",
Division)
) %>%
semi_join(aec_data %>%
rename(Division = DivisionNm),
by = "Division") %>%
left_join(aec_data %>%
select(state = StateAb,
Division = DivisionNm),
by = "Division") %>%
select(state,Division,Enrolment)
enrolment_rates <- read_csv(
file =
here(
"common_data/elections/aec/elector_counts/2022-06-div-enrol-rate.csv"
)
) %>%
mutate(
enrolment_rate_actual =
case_match(
Enrolment_Rate,
"98% or over" ~ .99,
"95% to less than 98%" ~ .965,
"90% to less than 95%" ~ .925,
"85% to less than 90%" ~ .875,
"80% to less than 85%" ~ .825,
"75% to less than 80%" ~ .775
)
) %>%
rename(state = State)
enrolment
vote_long <- fp %>%
select(state = StateAb,
Division = DivisionNm,
j = PartyAb,
n = TotalVotes) %>%
mutate(
vote_2022 = case_match(
j,
"ALP" ~ "ALP",
"GRN" ~ "GRN",
"LP" ~ "Coalition",
"NP" ~ "Coalition",
"LNP" ~ "Coalition",
"CLP" ~ "Coalition",
"UAPP" ~ "UAP_ON",
"ON" ~ "UAP_ON",
"IND" ~ "IND",
"INF" ~ "INF",
.default = "OTH"
)
) %>%
select(-j) %>%
group_by(state,Division,vote_2022) %>%
summarise(n = sum(n)) %>%
ungroup() %>%
pivot_wider(
id_cols = c("state","Division"),
names_from = "vote_2022",
values_from = "n",
values_fill = 0) %>%
left_join(
turnout %>%
select(state = StateAb,
Division = DivisionNm,
Turnout),
by = c("state","Division")
) %>%
left_join(
enrolment,
by = c("state","Division")
) %>%
left_join(
enrolment_current,
by = c("state","Division")
) %>%
left_join(
enrolment_rates %>%
rename(state = State) %>%
select(-Enrolment_Rate),
by = c("state","Division")
)
rlang::last_trace()
enrolment_rates
vote_long <- fp %>%
select(state = StateAb,
Division = DivisionNm,
j = PartyAb,
n = TotalVotes) %>%
mutate(
vote_2022 = case_match(
j,
"ALP" ~ "ALP",
"GRN" ~ "GRN",
"LP" ~ "Coalition",
"NP" ~ "Coalition",
"LNP" ~ "Coalition",
"CLP" ~ "Coalition",
"UAPP" ~ "UAP_ON",
"ON" ~ "UAP_ON",
"IND" ~ "IND",
"INF" ~ "INF",
.default = "OTH"
)
) %>%
select(-j) %>%
group_by(state,Division,vote_2022) %>%
summarise(n = sum(n)) %>%
ungroup() %>%
pivot_wider(
id_cols = c("state","Division"),
names_from = "vote_2022",
values_from = "n",
values_fill = 0) %>%
left_join(
turnout %>%
select(state = StateAb,
Division = DivisionNm,
Turnout),
by = c("state","Division")
) %>%
left_join(
enrolment,
by = c("state","Division")
) %>%
left_join(
enrolment_current,
by = c("state","Division")
) %>%
left_join(
enrolment_rates %>%
select(-Enrolment_Rate),
by = c("state","Division")
)
vote_long
enrolment_current <- read_csv(
file =
here(
"common_data/elections/aec/elector_counts/DivisionalEnrolment/2023_05.csv"
),
skip = 1
) %>%
mutate(Division = str_to_title(Division),
Enrolment_Current = as.numeric(Enrolment)) %>%
mutate(
Division = gsub(
Division,
pattern = "Mc([a-z])",
replacement = "Mc\\U\\1",
perl = TRUE
),
Division = if_else(Division == "O'connor",
"O'Connor",
Division)
) %>%
semi_join(aec_data %>%
rename(Division = DivisionNm),
by = "Division") %>%
left_join(aec_data %>%
select(state = StateAb,
Division = DivisionNm),
by = "Division") %>%
select(state,Division,Enrolment_Current)
enrolment_current <- read_csv(
file =
here(
"common_data/elections/aec/elector_counts/DivisionalEnrolment/2023_05.csv"
),
skip = 1
) %>%
mutate(Division = str_to_title(Division),
Enrolment_Current = as.numeric(Enrolment)) %>%
mutate(
Division = gsub(
Division,
pattern = "Mc([a-z])",
replacement = "Mc\\U\\1",
perl = TRUE
),
Division = if_else(Division == "O'connor",
"O'Connor",
Division)
) %>%
semi_join(aec_data %>%
rename(Division = DivisionNm),
by = "Division") %>%
left_join(aec_data %>%
select(state = StateAb,
Division = DivisionNm),
by = "Division") %>%
select(state,Division,Enrolment_Current)
enrolment_current <- read_csv(
file =
here(
"common_data/elections/aec/elector_counts/DivisionalEnrolment/2023_05.csv"
),
skip = 1
) %>%
mutate(Division = str_to_title(Division),
Enrolment_Current = as.numeric(Enrolment)) %>%
mutate(
Division = gsub(
Division,
pattern = "Mc([a-z])",
replacement = "Mc\\U\\1",
perl = TRUE
),
Division = if_else(Division == "O'connor",
"O'Connor",
Division)
) %>%
semi_join(aec_data,
by = "Division") %>%
left_join(aec_data,
by = "Division") %>%
select(state,Division,Enrolment_Current)
enrolment_current
enrolment
d
source("~/Documents/Projects/oz/2022/small_area_estimation/code/ced_features_new.R", echo=TRUE)
vote_long <- fp %>%
select(state = StateAb,
Division = DivisionNm,
j = PartyAb,
n = TotalVotes) %>%
mutate(
vote_2022 = case_match(
j,
"ALP" ~ "ALP",
"GRN" ~ "GRN",
"LP" ~ "Coalition",
"NP" ~ "Coalition",
"LNP" ~ "Coalition",
"CLP" ~ "Coalition",
"UAPP" ~ "UAP_ON",
"ON" ~ "UAP_ON",
"IND" ~ "IND",
"INF" ~ "INF",
.default = "OTH"
)
) %>%
select(-j) %>%
group_by(state,Division,vote_2022) %>%
summarise(n = sum(n)) %>%
ungroup() %>%
pivot_wider(
id_cols = c("state","Division"),
names_from = "vote_2022",
values_from = "n",
values_fill = 0) %>%
left_join(
turnout %>%
select(state = StateAb,
Division = DivisionNm,
Turnout),
by = c("state","Division")
) %>%
left_join(
enrolment,
by = c("state","Division")
) %>%
left_join(
enrolment_current,
by = c("state","Division")
) %>%
left_join(
enrolment_rates %>%
select(-Enrolment_Rate),
by = c("state","Division")
)
vote_long
vote_long <- vote_long %>%
mutate(
Eligible = Enrolment_Current/enrolment_rate_actual,
adj = 1 + INF/(Turnout - INF),
across(.cols = c("ALP","Coalition","GRN","IND","UAP_ON","OTH"),
~ .x*adj,
.names = "{.col}_adj"
),
NV_adj = Eligible - Turnout)
save("vote_long",
file =
here(
"common_data/elections/aec/2022/vote_long.RData"
)
)
source("~/Documents/Projects/oz/2022/small_area_estimation/code/ced_features_new.R", echo=TRUE)
#| echo: false
#| results: hide
## AEC list of Division names
load(here("common_data/elections/aec/2022/ced_results.RData"))
#| echo: false
#| message: false
library(conflicted)
library(tidyverse)
library(here)
library(fst)
library(knitr)
library(kableExtra)
library(ggplot2)
library(sf)
conflicts_prefer(dplyr::filter)
#| echo: false
#| results: hide
## AEC list of Division names
load(here("common_data/elections/aec/2022/ced_results.RData"))
ced_path <- "common_data/Census/2021/CED"
sed_path <- "common_data/Census/2021/SED"
sa4_path <- "common_data/Census/2021/SA4"
sa1_path <- "common_data/Census/2021/SA1"
lga_path <- "common_data/Census/2021/LGA"
poa_path <- "common_data/Census/2021/POA"
sa1_eval <- FALSE
age_gender_counts_raw <- read_csv(
file = url(
"https://www.aec.gov.au/Enrolling_to_vote/Enrolment_stats/elector_count/2023/elector-count-mar-2023.csv"
),
skip = 9
)
age_gender_counts <- age_gender_counts_raw %>%
rename(Division = `...1`) %>%
janitor::remove_empty("cols") %>%
mutate(across(.cols = -Division,
.fn = ~ as.numeric(gsub(as.character(.x),pattern="\\,",replacement="")))) %>%
pivot_longer(cols = -Division,names_to = "age",values_to = "n") %>%
mutate(n = if_else(is.na(n),0,n)) %>%
filter(!(Division %in% c("NSW","VIC","QLD","SA","WA","TAS","ACT","SA","Grand Total"))) %>%
filter(age != "TOTAL") %>%
mutate(gender = Division) %>%
mutate(Division = if_else(
Division %in% c("Male","Female","Indeterminate/Unknown"),
NA,
Division)) %>%
tidyr::fill(Division,
.direction = "down") %>%
mutate(gender = if_else(gender == Division,"All",gender)) %>%
filter(age != "16-17" & gender %in% c("Male","Female")) %>%
semi_join(
aec_data,
by = "Division") %>%
mutate(j = paste(age,gender,sep = ":")) %>%
select(Division,j,age,gender,n) %>%
mutate(p = n/sum(n), .by = "Division")
load(here("common_data/Census/2021/CED/ced.RData"))
library(here)
load(here("common_data/Census/2021/CED/ced.RData"))
#| label: load-political-characteristics-of-seats
load(here("common_data/elections/aec/2022/ced_results.RData"))
aec_data$CED_CODE_2021
enrolment_current <- read_csv(
file =
here(
"common_data/elections/aec/elector_counts/DivisionalEnrolment/2023_05.csv"
),
skip = 1
) %>%
mutate(Division = str_to_title(Division),
Enrolment_Current = as.numeric(Enrolment)) %>%
mutate(
Division = gsub(
Division,
pattern = "Mc([a-z])",
replacement = "Mc\\U\\1",
perl = TRUE
),
Division = if_else(Division == "O'connor",
"O'Connor",
Division)
) %>%
semi_join(aec_data,
by = "Division") %>%
left_join(aec_data,
by = "Division") %>%
select(state,Division,Enrolment_Current)
enrolment_rates <- read_csv(
file =
here(
"common_data/elections/aec/elector_counts/2022-06-div-enrol-rate.csv"
)
) %>%
mutate(
enrolment_rate_actual =
case_match(
Enrolment_Rate,
"98% or over" ~ .99,
"95% to less than 98%" ~ .965,
"90% to less than 95%" ~ .925,
"85% to less than 90%" ~ .875,
"80% to less than 85%" ~ .825,
"75% to less than 80%" ~ .775
)
) %>%
rename(state = State)
source("~/Documents/Projects/oz/2022/small_area_estimation/code/ced_features_new.R", echo=TRUE)
install.packages("gargle")
load(here("common_data/elections/aec/2022/ced_results.RData"))
aec_data$Turnout
sum(aec_data$Turnout)
aec_data
aec_data %>% colnames()
turnout <- read_csv(
file = url(
"https://results.aec.gov.au/27966/Website/Downloads/HouseTurnoutByDivisionDownload-27966.csv"
),
skip = 1
)
turnout
sum(turnout$Turnout)
theFiles <- list.files(path = here("data/2022/final"),
pattern = "HouseState",
full.names = TRUE)
aec_results <- list()
for (f in theFiles) {
aec_results[[f]] <- read_csv(file = f, skip = 1)
}
aec_results <- bind_rows(aec_results) %>%
rename(pp_id = PollingPlaceID,
pp_nm = PollingPlace,
div_nm = DivisionNm)
## pick up postals etc
aec_extra <- read_csv(file = here("data/2022/final/HouseFirstPrefsByCandidateByVoteTypeDownload-27966.csv"),
skip=1) %>%
select(-OrdinaryVotes,-TotalVotes) %>%
rename(div_nm = DivisionNm) %>%
pivot_longer(cols = ends_with("Votes"),
names_to = "PollingPlace",
values_to = "votes") %>%
select(div_nm,pp_nm = PollingPlace,votes) %>%
mutate(pp_nm = str_remove(pp_nm,"Votes")) %>%
filter(pp_nm != "Total") %>%  ##& pp_nm != "PrePoll") %>%
mutate(pp_nm = if_else(pp_nm == "PrePoll",
"Pre-Poll",
pp_nm)
) %>%
group_by(div_nm,pp_nm) %>%
summarise(v = sum(votes)) %>%
ungroup() %>%
mutate(pp_id = 0)
aec_ppid <- aec_results %>%
group_by(div_nm,pp_id,pp_nm) %>%
summarise(v = sum(OrdinaryVotes)) %>%
ungroup() %>%
bind_rows(aec_extra) %>%
arrange(div_nm,pp_id)
sum(aec_ppid$v)
sum(sa1$votes)
library(knitr)
library(tidyverse)
library(here)
sa1 <-
read.csv(file = here("common_data/Census/2021/SA1/2022-federal-election-votes-sa1.csv")) %>%
filter(votes > 0)
sum(sa1$votes)
